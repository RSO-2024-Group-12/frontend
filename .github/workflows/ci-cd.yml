name: Angular CI/CD to Kubernetes

on:
  push:
    branches: [ "main" ]

jobs:
  build-test:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      # Set up Node.js
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"

      # Install pnpm
      - name: Install pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 9

      # Install dependencies
      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      # Build Angular app
      - name: Build Angular app
        run: pnpm run build --configuration production

  docker-and-deploy:
    needs: build-test
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      # Docker buildx
      - name: Set up Docker
        uses: docker/setup-buildx-action@v3

      # Login to GitHub Container Registry
      - name: Login to GitHub Container Registry
        run: echo ${{ secrets.GITHUB_TOKEN }} | docker login ghcr.io -u ${{ github.actor }} --password-stdin

      # Build Docker image
      - name: Build Docker image
        run: |
          OWNER=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
          REPO=$(echo "${{ github.event.repository.name }}" | tr '[:upper:]' '[:lower:]')
          IMAGE=ghcr.io/$OWNER/$REPO:${{ github.sha }}

          docker build -t $IMAGE .
          docker push $IMAGE

#      - name: Configure kubeconfig
#        run: |
#          mkdir -p ~/.kube
#          echo "${{ secrets.KUBE_CONFIG }}" | base64 --decode > ~/.kube/config
#
#      - name: Install Helm
#        run: |
#          curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
#
#      - name: Deploy to Kubernetes
#        run: |
#          OWNER=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
#          REPO=$(echo "${{ github.event.repository.name }}" | tr '[:upper:]' '[:lower:]')
#          IMAGE=ghcr.io/$OWNER/$REPO
#
#          helm upgrade --install $REPO ./helm \
#            --set image.repository=$IMAGE \
#            --set image.tag=${{ github.sha }}
