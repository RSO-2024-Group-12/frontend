<div class="container mx-auto p-4 max-w-7xl">
  <p-toast></p-toast>

  <div class="mb-6">
    <h2 class="text-3xl font-bold mb-2">Upravljanje skladišča</h2>
    <p class="text-gray-600">Pregled zalog in upravljanje s skladiščem</p>
  </div>

  <div class="mb-4">
    <p-iconfield iconPosition="left" class="w-full max-w-md">
      <p-inputicon styleClass="pi pi-search" />
      <input
        pInputText
        type="text"
        placeholder="Išči izdelke..."
        (input)="onSearchInput($event)"
        class="w-full"
      />
    </p-iconfield>
  </div>

  @if (loading()) {
    <div class="flex justify-center p-8">
      <p-progressSpinner></p-progressSpinner>
    </div>
  } @else {
    <p-card>
      <div class="flex justify-end">
        <p-button styleClass="text-nowrap" [outlined]="true" (onClick)="openAddItemDialog()"
          >Dodaj izdelek</p-button
        >
      </div>
      @if (filteredProductsWithStock().length > 0) {
        <p-table
          [value]="filteredProductsWithStock()"
          [paginator]="true"
          [rows]="10"
          [responsiveLayout]="'scroll'"
        >
          <ng-template pTemplate="header">
            <tr>
              <th>Izdelek</th>
              <th class="text-center">Status</th>
              <th class="text-center">Na zalogi</th>
              <th class="text-center">Rezervirano</th>
              <th class="text-center">Dostopno</th>
              <th class="text-right">Cena</th>
              <th style="width: 12rem"></th>
              <th style="width: 6rem"></th>
            </tr>
          </ng-template>

          <ng-template pTemplate="body" let-item>
            <tr>
              <td>
                <div class="flex items-center gap-3">
                  @if (item.product.slike?.[0]?.url) {
                    <img [src]="item.product.slike[0].url" class="w-12 h-12 object-cover rounded" />
                  } @else {
                    <div class="w-12 h-12 bg-gray-200 rounded flex items-center justify-center">
                      <i class="pi pi-image text-gray-400"></i>
                    </div>
                  }
                  <div>
                    <div class="font-semibold">{{ item.product.naziv }}</div>
                    <div class="text-sm text-gray-500">ID: {{ item.product.id_izdelek }}</div>
                  </div>
                </div>
              </td>

              <td class="text-center">
                <p-tag
                  [value]="item.product.aktiven ? 'Aktiven' : 'Neaktiven'"
                  [severity]="item.product.aktiven ? 'success' : 'danger'"
                ></p-tag>
              </td>

              <td class="text-center">
                <span class="font-semibold">{{ item.stock?.stock ?? 0 }}</span>
              </td>

              <td class="text-center">
                <span class="font-semibold">{{ item.stock?.reserved ?? 0 }}</span>
              </td>
              @let availableStock = (item.stock?.stock ?? 0) - (item.stock?.reserved ?? 0);
              <td class="text-center">
                <p-tag
                  [value]="availableStock.toString()"
                  [severity]="getStockSeverity(availableStock)"
                ></p-tag>
              </td>

              <td class="text-right">
                <span class="font-semibold">{{ item.product.cena | number: '1.2-2' }} €</span>
              </td>

              <td class="text-center">
                <div class="flex gap-2 justify-center">
                  <p-button
                    icon="pi pi-plus"
                    [rounded]="true"
                    [outlined]="true"
                    severity="success"
                    size="small"
                    pTooltip="Dodaj zalogo"
                    (onClick)="addStock(item.product.id_izdelek)"
                  ></p-button>
                  <p-button
                    icon="pi pi-minus"
                    [rounded]="true"
                    [outlined]="true"
                    severity="warn"
                    size="small"
                    pTooltip="Odstrani zalogo"
                    (onClick)="removeStock(item.product.id_izdelek)"
                  ></p-button>
                </div>
              </td>
              <td>
                <p-button
                  styleClass="text-nowrap"
                  [outlined]="true"
                  severity="danger"
                  (onClick)="removeItem(item.product.id_izdelek)"
                  >Odstrani izdelek</p-button
                >
              </td>
            </tr>
          </ng-template>
        </p-table>
      } @else {
        <div class="text-center p-8">
          <p-card>
            <i class="pi pi-warehouse text-6xl text-gray-300 mb-4"></i>
            <p class="text-xl text-gray-500 mb-4">Ni najdenih izdelkov</p>
          </p-card>
        </div>
      }
    </p-card>
  }
</div>
<p-dialog
  header="Dodaj nov izdelek"
  [modal]="true"
  [style]="{ width: '500px' }"
  [(visible)]="showAddDialog"
>
  <div class="flex flex-col gap-4">
    <input pInputText placeholder="Naziv" [(ngModel)]="newProduct().naziv" />

    <textarea pInputTextarea rows="3" placeholder="Opis" [(ngModel)]="newProduct().opis"></textarea>

    <input pInputText type="number" placeholder="Cena (€)" [(ngModel)]="newProduct().cena" />

    <div class="flex gap-2 align-items-center">
      <p-checkbox binary="true" [(ngModel)]="newProduct().aktiven"></p-checkbox>
      <label>Aktiven</label>
    </div>

    <h4>Lastnosti</h4>
    @for (l of newProduct().lastnostiDodaj; let i = $index; track i) {
      <div class="flex gap-2">
        <input pInputText placeholder="Lastnost" [(ngModel)]="l.lastnost" />
        <input pInputText placeholder="Vrednost" [(ngModel)]="l.vrednost" />
        <p-button
          icon="pi pi-times"
          severity="danger"
          [text]="true"
          (onClick)="removeProperty(i)"
        ></p-button>
      </div>
    }
    <p-button icon="pi pi-plus" label="Dodaj lastnost" (onClick)="addProperty()"></p-button>

    <h4>Slike (URL)</h4>
    @for (s of newProduct().slikeDodaj; let i = $index; track i) {
      <div class="flex gap-2">
        <input pInputText placeholder="https://..." [(ngModel)]="s.url" />
        <p-button
          icon="pi pi-times"
          severity="danger"
          [text]="true"
          (onClick)="removeImage(i)"
        ></p-button>
      </div>
    }
    <p-button icon="pi pi-plus" label="Dodaj sliko" (onClick)="addImage()"></p-button>
  </div>

  <ng-template pTemplate="footer">
    <p-button label="Prekliči" severity="secondary" (onClick)="showAddDialog.set(false)"></p-button>
    <p-button label="Shrani" icon="pi pi-check" (onClick)="saveNewProduct()"></p-button>
  </ng-template>
</p-dialog>
